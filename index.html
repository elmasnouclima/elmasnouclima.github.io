<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#0a5ca8">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="icon" sizes="192x192" href="icons/icon-192.png">
  <title>Mi Estación | Weathercloud + WU</title>
  <link rel="stylesheet" href="assets/styles.css">
  <script>
    function updateOnlineStatus(){ document.documentElement.classList.toggle('offline', !navigator.onLine); }
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    window.addEventListener('load', updateOnlineStatus);
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(console.error);
      });
    }
  </script>
</head>
<body>
  <header>
    <img class="logo" src="icons/icon-192.png" alt="icono">
    <h1>Mi Estación — PWA</h1>
  </header>

  <main>
    <!-- TARJETA PRINCIPAL (pegatina Weathercloud) -->
    <div class="card">
      <img class="sticker" src="https://app.weathercloud.net/device/sticker/4096084067" alt="Weathercloud sticker de mi estación" loading="lazy" />
      <div class="actions">
        <a class="button" href="https://app.weathercloud.net/d4096084067" target="_blank" rel="noopener">Abrir panel completo</a>
        <button class="secondary" onclick="window.location.reload()">Actualizar</button>
      </div>
      <div class="offline-note">Estás sin conexión. Verás esta pegatina en caché. El panel completo requiere conexión.</div>
    </div>

    <!-- NUEVA TARJETA WU (debe verse DEBAJO de la pegatina) -->
    <div class="card" style="margin-top:12px">
      <h2 style="margin:0 0 8px 0">Datos en tiempo real (WU)</h2>
      <div id="wu-status" style="font-size:0.9rem;opacity:0.8">Cargando…</div>
      <div id="wu-current" style="margin-top:8px"></div>
    </div>
  </main>

  <footer>
    Hecho para mostrar Weathercloud + datos WU en tu móvil.
  </footer>
<!-- Carga del script WU (con versión para evitar caché) -->
<script src="assets/wu.js?v=1"></script>
<script>
// TEST inmediato: cambia el texto si el script se ejecuta
(function(){
  var s = document.getElementById('wu-status');
  if (s) s.textContent = 'Script WU arrancó';
})();

// === Config WU ===
const WU = {
  stationId: "IELMAS44",
  apiKey: "fa484bd110b24b3b884bd110b2fb3bef",
  units: "m"
};

function setMsg(txt) {
  const el = document.getElementById("wu-status");
  if (el) el.textContent = txt;
}

async function wuFetchCurrent() {
  const url = `https://api.weather.com/v2/pws/observations/current?stationId=${WU.stationId}&format=json&units=${WU.units}&apiKey=${WU.apiKey}&_=${Date.now()}`;
  const r = await fetch(url);
  if (!r.ok) throw new Error(`WU HTTP ${r.status}`);
  const data = await r.json();
  if (!data || !data.observations || !data.observations[0]) {
    throw new Error("Respuesta sin observaciones");
  }
  return data.observations[0];
}

function renderCurrent(obs) {
  const el = document.getElementById("wu-current");
  if (!el) { setMsg("No existe el contenedor #wu-current"); return; }

  const t  = obs.metric?.temp ?? "–";
  const h  = obs.humidity ?? "–";
  const ws = obs.metric?.windSpeed ?? "–";
  const wg = obs.metric?.windGust ?? "–";
  const pr = obs.metric?.precipRate ?? "–";
  const p  = obs.metric?.pressure ?? "–";
  const ts = obs.obsTimeUtc ? new Date(obs.obsTimeUtc + "Z").toLocaleString() : "—";

  el.innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px">
      <div><strong>Temperatura:</strong> ${t} °C</div>
      <div><strong>Humedad:</strong> ${h} %</div>
      <div><strong>Viento:</strong> ${ws} km/h (racha ${wg})</div>
      <div><strong>Lluvia (inst.):</strong> ${pr} mm/h</div>
      <div><strong>Presión:</strong> ${p} hPa</div>
      <div><strong>Hora obs.:</strong> ${ts}</div>
    </div>
  `;
}

window.addEventListener("load", async () => {
  setMsg("Script WU cargado. Pidiendo datos…");
  try {
    const obs = await wuFetchCurrent();
    renderCurrent(obs);
    setMsg("WU OK");
  } catch (e) {
    setMsg("WU error: " + (e?.message || e));
    console.error(e);
  }
});
</script>

  
</body>
</html>
